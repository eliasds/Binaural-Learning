<!DOCTYPE html>
<html>
<head>
	<title>Spotify Web API Example</title>
	<!-- use this one --> <script src="https://unpkg.com/tone"></script>
	<script src="tone.js"></script> <!--local file-->
	<script src="callback.js"></script> <!--local file-->
	<script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
	<h1>Spotify Web API Example v6</h1>

	<button id="login-button">Log in with Spotify</button>
	<button id="play-button">Play</button>
	<button id="pause-button">Pause</button>

	<script>
    // Spotify Web API credentials
    const CLIENT_ID = 'f1692e4b1b6d44d4bafa58860c5cf9ca';		
    //const REDIRECT_URI = 'https://eliasds.github.io/Binaural-Learning/redirect.html';
    const SCOPES = 'user-read-playback-state user-modify-playback-state';
    const REDIRECT_URI = 'http://localhost:8000/callback.html';

// Check if the access token is stored in localStorage
const token = localStorage.getItem('access_token');
if (token) {
  // Initialize the Spotify Web Playback SDK
  window.onSpotifyWebPlaybackSDKReady = () => {
    console.log('Spotify Web Playback SDK is ready');
    initializePlayer(token);
  };
} else {
  // Display the login button
  document.querySelector('#login-button').style.display = 'block';
}

// Initialize the Spotify Web Playback SDK with the access token
function initializePlayer(token) {
  // Initialize the Spotify Web Playback SDK
  window.onSpotifyPlayerAPIReady = () => {
    console.log('Spotify Player API is ready');
    // Set up the Spotify Web Playback SDK with our credentials
    const player = new Spotify.Player({
      name: 'My Spotify Player',
      getOAuthToken: (cb) => {
        cb(token);
      }
    });
    // Connect to the player and start playback
    player.connect().then(success => {
      if (success) {
        console.log('The Web Playback SDK successfully connected to Spotify!');
        // Get a random track from Spotify and play it
        getRandomTrack(token).then(track => {
          console.log('Selected track:', track);
          player.resume();
          player.play({
            uris: [track.uri]
          });
        });
      }
    }).catch(error => {
      console.error(error);
    });
    // Listen for playback state changes
    player.addListener('player_state_changed', state => {
      console.log('Player state changed:', state);
    });
    // Set up the Play button
    document.querySelector('#play-button').addEventListener('click', () => {
      player.resume();
    });
    // Set up the Pause button
    document.querySelector('#pause-button').addEventListener('click', () => {
      player.pause();
    });
  };
}

// Get a random track from Spotify
async function getRandomTrack(token) {
  try {
    // Get the user's top tracks
    const response = await fetch('https://api.spotify.com/v1/me/top/tracks?time_range=medium_term&limit=50', {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    const data = await response.json();
    const tracks = data.items;
    // Select a random track
    const randomIndex = Math.floor(Math.random() * tracks.length);
    const track = tracks[randomIndex];
    return track;
  } catch (error) {
    console.error(error);
  }
}

// Log in with Spotify
document.querySelector('#login-button').addEventListener('click', () => {
  const url = `https://accounts.spotify.com/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
  window.location.href = url;
});


  </script>
</body>
</html>
